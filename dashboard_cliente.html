<!-- GURIRI EXPRESS | DASHBOARD LXP -->
<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>GURIRI EXPRESS ‚ö° Painel Hologr√°fico do Cliente</title>
<meta name="theme-color" content="#05080d"/>
<style>
:root{
  --bg:#05080d;--panel:#090e13;--ink:#e8fcff;--muted:#a8c8d0;
  --neon:#00eaff;--bio:#00ffc8;--vio:#b28dff;--warn:#ffd84d;--danger:#ff6b6b;
}
*{box-sizing:border-box}
body{margin:0;padding:20px;background:radial-gradient(1200px 700px at 50% -10%,#08121a,#030609);color:var(--ink);font:16px/1.45 'Inter',system-ui}
h1,h2{margin:0;text-align:center}
h1{font-size:2.4rem;font-weight:900;background:linear-gradient(90deg,var(--neon),var(--vio));-webkit-background-clip:text;color:transparent;text-shadow:0 0 20px #00eaff66,0 0 40px #b28dff33}
.shell{max-width:900px;margin:0 auto}
.card{background:rgba(12,18,24,0.8);border:1px solid #0ff4;border-radius:20px;padding:24px;box-shadow:0 0 40px #00f2ff11,0 0 8px #00ffc422 inset}
label{display:block;margin:10px 0 4px;color:var(--muted)}
input,textarea{width:100%;background:#0c141a;border:1px solid #1b2c36;border-radius:10px;padding:10px;color:var(--ink)}
button{cursor:pointer;border:none;border-radius:12px;padding:14px 18px;font-weight:800;transition:.2s}
.btn-main{background:linear-gradient(90deg,var(--neon),var(--bio));color:#000;box-shadow:0 0 20px #00f2ff77}
.btn-main:hover{transform:scale(1.02);box-shadow:0 0 30px #00ffc977}
.timeline{border-left:3px solid var(--neon);margin-top:20px;padding-left:20px;position:relative}
.timeline::before{content:"";position:absolute;left:-3px;top:0;bottom:0;width:3px;background:linear-gradient(var(--neon),transparent)}
.t-dot{width:14px;height:14px;border-radius:50%;background:#111;box-shadow:0 0 8px var(--neon);position:absolute;left:-31px;animation:pulse 2s infinite alternate}
@keyframes pulse{to{box-shadow:0 0 18px var(--neon)}}
.msg{margin:5px 0;padding:8px 12px;border-radius:14px;max-width:80%}
.msg.bot{background:#102040;align-self:flex-start}
.msg.user{background:#103021;align-self:flex-end;margin-left:auto}
#chatbox{position:fixed;bottom:20px;right:20px;width:320px;height:420px;background:rgba(10,15,20,0.95);border:1px solid var(--vio);border-radius:14px;display:none;flex-direction:column;backdrop-filter:blur(8px)}
#chathead{background:linear-gradient(90deg,var(--vio),var(--neon));padding:10px;border-radius:13px 13px 0 0;text-align:center;font-weight:700}
#chatstream{flex:1;overflow-y:auto;display:flex;flex-direction:column;padding:10px}
#chatinput{display:flex;border-top:1px solid #1b2c36}
#chatinput input{flex:1;background:transparent;border:none;padding:10px;color:var(--ink)}
#chatinput button{background:var(--bio);color:#000;border:none;padding:10px;border-radius:10px;margin:5px}
#chat-toggle{position:fixed;bottom:20px;right:20px;width:60px;height:60px;border-radius:50%;border:none;background:radial-gradient(circle at 30% 30%,var(--neon),var(--vio));box-shadow:0 0 25px #00eaffaa;font-size:26px;color:#000}
</style>
</head>
<body>
<div class="shell">
  <h1>GURIRI EXPRESS ‚Ä¢ Dashboard LXP Ultrass√¥nico ‚ö°</h1>
  <div class="card" id="formCard">
    <h2>Nova Miss√£o de Entrega</h2>
    <form id="pedidoForm">
      <label>Cliente / Com√©rcio</label><input id="cli" required>
      <label>Endere√ßo de Coleta</label><input id="col" required>
      <label>CEP (ex.: 29000-000)</label><input id="cep" required pattern="[0-9]{5}-?[0-9]{3}" placeholder="00000-000">
      <label>Refer√™ncia</label><input id="reference">
      <label>Endere√ßo de Entrega</label><input id="ent" required>
      <label>Valor (R$)</label><input id="valor" type="number" step="0.01" min="0" value="0">
      <label>Forma de Pagamento</label>
      <select id="payment_method">
        <option value="cartao_credito">Cart√£o de cr√©dito</option>
        <option value="cartao_debito">Cart√£o de d√©bito</option>
        <option value="pix">PIX</option>
        <option value="dinheiro">Dinheiro</option>
      </select>
      <div id="change_box" style="display:none;margin-top:8px">
        <label><input type="checkbox" id="has_change"> Haver√° troco?</label>
        <input id="change_for" type="number" step="0.01" min="0" value="0" placeholder="Valor do troco (R$)">
      </div>
      <label>Detalhes / Observa√ß√µes</label><textarea id="obs" rows="2"></textarea>
      <button class="btn-main" type="submit">üöÄ Lan√ßar via IA Express (TCZ)</button>
    </form>
  </div>

  <div class="card" id="trackCard" style="display:none">
    <h2>Status Hologr√°fico</h2>
    <div id="timeline" class="timeline"></div>
    <button class="btn-main" id="download" disabled>üîí Baixar Live Docs‚Ñ¢</button>
  </div>
</div>

<button id="chat-toggle" onclick="toggleChat()">üí¨</button>
<div id="chatbox">
  <div id="chathead">THOR ‚Ä¢ Suporte Qu√¢ntico</div>
  <div id="chatstream"></div>
  <div id="chatinput">
    <input id="msg" placeholder="Digite sua mensagem..."/>
    <button onclick="send()">‚û§</button>
  </div>
</div>

<script>
/* === CONFIG === */
let CLIENTE_ID = 'cliente_01';
const wsProto = location.protocol === 'https:' ? 'wss' : 'ws';
let ws;

/* === WEBSOCKET & AUTH === */
async function ensureAuth(defaultId){
  // simple prompt-based login for development. Stores access/refresh in localStorage.
  let access = localStorage.getItem('guriri_access');
  let refresh = localStorage.getItem('guriri_refresh');
  let uid = localStorage.getItem('guriri_user') || defaultId;
  if (!access){
    uid = prompt('Digite seu id (ex: cliente_01):', defaultId) || defaultId;
    const pwd = prompt('Senha para ' + uid + ':');
    if (!pwd){ alert('Autentica√ß√£o necess√°ria'); throw new Error('no password'); }
    try{
      const r = await fetch('/api/auth/login', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({id:uid,password:pwd})});
      if(!r.ok){ alert('Falha ao autenticar: '+(await r.text())); throw new Error('auth failed'); }
      const j = await r.json();
      access = j.access_token;
      refresh = j.refresh_token;
      localStorage.setItem('guriri_access', access);
      localStorage.setItem('guriri_refresh', refresh);
      localStorage.setItem('guriri_user', j.id);
    }catch(e){ console.warn('auth error', e); throw e }
  }
  return { access_token: localStorage.getItem('guriri_access'), refresh: localStorage.getItem('guriri_refresh'), id: localStorage.getItem('guriri_user')||defaultId };
}

async function connectWS(){
  const auth = await ensureAuth(CLIENTE_ID);
  CLIENTE_ID = auth.id;
  const token = encodeURIComponent(auth.access_token || '');
  ws = new WebSocket(`${wsProto}://${location.host}/ws/${CLIENTE_ID}?token=${token}`);
  ws.onopen=()=>log("üîó Conectado ao servidor IA Express",true);
  ws.onmessage=(ev)=>{
    const msg=JSON.parse(ev.data);
    if(msg.type==='order_update'){ log(msg.payload.text||"Atualiza√ß√£o recebida"); }
    if(msg.type==='chat'){ append(`${msg.payload.from||'Central'}: ${msg.payload.text}`,'bot'); }
  };
  ws.onclose=()=>setTimeout(connectWS,3000);
}
connectWS();

/* === FORM === */
const form=document.getElementById('pedidoForm');
form.onsubmit=async e=>{
 e.preventDefault();
 const data={
   cliente:cli.value,
   coleta:col.value,
   cep: document.getElementById('cep').value,
   reference: document.getElementById('reference').value,
   entrega:ent.value,
   obs:obs.value,
   valor: document.getElementById('valor').value,
   payment_method: document.getElementById('payment_method').value,
   change_for: document.getElementById('has_change').checked ? document.getElementById('change_for').value : 0
 };
 document.getElementById('formCard').style.display='none';
 document.getElementById('trackCard').style.display='block';
 log("Pedido lan√ßado ‚Ä¢ IA Express iniciou miss√£o",true);

 try{
   const r=await fetch('/api/pedido',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(data)});
   const j=await r.json();
   log(`üì¶ Pedido #${j.id} registrado`);
 }catch(err){
   log("‚ö†Ô∏è Falha ao enviar pedido. Opera√ß√£o offline, ser√° reenviada.");
 }
};

// payment UI: show change field when dinheiro
document.getElementById('payment_method').addEventListener('change', function(){
  const v = this.value;
  if(v === 'dinheiro') document.getElementById('change_box').style.display = 'block';
  else document.getElementById('change_box').style.display = 'none';
});

/* === TIMELINE === */
const t=document.getElementById('timeline');
function log(txt,first){
 const e=document.createElement('div');
 e.innerHTML=`<div class='t-dot'></div><div style='margin-left:10px;'>${txt}</div>`;
 t.appendChild(e);t.lastChild.scrollIntoView({behavior:'smooth'});
 if(!first && 'speechSynthesis'in window){speechSynthesis.speak(new SpeechSynthesisUtterance(txt));}
}

/* === CHAT === */
const s=document.getElementById('chatstream');
function toggleChat(){const b=document.getElementById('chatbox');b.style.display=b.style.display==='flex'?'none':'flex';}
function append(t,who){const p=document.createElement('div');p.className='msg '+(who||'bot');p.textContent=t;s.appendChild(p);s.scrollTop=s.scrollHeight;}
function send(){
 const i=document.getElementById('msg').value.trim();
 if(!i)return;append(i,'user');document.getElementById('msg').value='';
 const m={type:'chat',payload:{from:CLIENTE_ID,to:'central',text:i}};
 if(ws&&ws.readyState===WebSocket.OPEN)ws.send(JSON.stringify(m));
}

/* === LIVE DOCS DOWNLOAD === */
document.getElementById('download').onclick=()=>{
  fetch('/api/docs/cliente/'+CLIENTE_ID)
   .then(r=>r.blob())
   .then(b=>{
      const u=URL.createObjectURL(b);
      const a=document.createElement('a');
      a.href=u;a.download='LiveDocs.zip';a.click();
   })
   .catch(()=>alert("Nenhum Live Docs dispon√≠vel."));
};
</script>
</body>
</html>
